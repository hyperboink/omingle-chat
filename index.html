<!DOCTYPE html>
<html>
  <head>
    <title>Omingle - Talk to strangers!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css">
  </head>
  <body>
    <div class="chat-intro">
        <div class="chat-intro-container">
            <h1 id="logo">Talk to Strangers!</h1>
            <span class="chat-btn">Chat!</span>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-head">
            <h2 class="chat-logo">Talk to Strangers!</h2>
        </div>

        <div class="chat-body">
            <ul class="chat-messages"></ul>
            <span class="chat-btn">Chat!</span>
        </div>

        <div class="chat-footer">
            <form class="chat-form">
                <span class="chat-stop">Stop :(</span>
                <input class="chat-input" autocomplete="off" />
                <button>Send</button>
            </form>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var chatIntroCard = document.getElementsByClassName('chat-intro')[0];
        var form = document.getElementsByClassName('chat-form')[0];
        var input = document.getElementsByClassName('chat-input')[0];
        var messages = document.getElementsByClassName('chat-messages')[0];
        var chatContainer = document.getElementsByClassName('chat-container')[0];
        var chatBtn = document.getElementsByClassName('chat-btn');
        var chatStopBtn = document.getElementsByClassName('chat-stop')[0];
        
        each(chatBtn, function(elem){
            elem.addEventListener('click', function(){
                elem.innerText = 'Looking...';
                connect();
            });
        });
        
        form.addEventListener('submit', function(e){
            var message = input.value.trim();
            
            if(message){
                sendMessage();
                
                socket.emit('send-message', {
                    message: message
                });
            }
            
            e.preventDefault();
        });

        document.addEventListener('click', function(e){
            var elem = e.target;

            if(elem.classList.contains('chat-stop')){
                if(!elem.classList.contains('warning')){
                    elem.classList.add('warning');
                    elem.innerText = 'Are You Sure?';
                }else{
                    socket.disconnect(true);
                    sendMessage('<div class="disconnect">You left in the chat.</div>', true);
                    disconnect();
                    elem.classList.remove('warning');
                    elem.innerText = 'Stop :(';
                    chatStopBtn.style.display = 'none';
                }
            }else{
                
            }
        });
        
        socket.on('room:created', function(data){
            chatInit();
            sendMessage(data.message, true);
        });

        socket.on('receive-message', function(data){
            sendMessage(data.message);
            console.log('done receive....');
        })

        socket.on('matched', function(data){
            sendMessage(data.message);
        });

        socket.on('chat:disconnected', function(){
            disconnect(true);
        });

        function chatInit(){
            each(chatBtn, function(elem){
                elem.innerText = 'Chat!';
                elem.style.display = 'none';
            });

            chatContainer.style.display = 'block';
            messages.innerHTML = '';
            chatIntroCard.style.display = 'none';
            chatStopBtn.style.display = 'inline-block';
        }

        function connect(){
            socket.connect();
            socket.emit('chat:matching');
        }

        function each(nodes, fn){
            Array.prototype.forEach.call(nodes, fn);
        }

        function sendMessage(message, ispromptMsg){
            var li = document.createElement('li');
            var person = message ? 'Stranger' : 'You';
            var messageContent = ispromptMsg
                ? message
                : '<span class="'+ (message ? 'stranger' : 'you') +'">' + person +'</span>: ' + (message || input.value);

            li.innerHTML = messageContent;
            messages.appendChild(li);
            window.scrollTo(0, document.body.scrollHeight);
            input.value = '';
        }

        function disconnect(hasMessage){
            if(hasMessage){
                sendMessage('<div class="disconnect">Stranger has left.</div>', true);
            }

            document.querySelector('.chat-body .chat-btn').style.display = 'inline-block';
            chatStopBtn.style.display = 'none';
        }
    </script>
  </body>
</html>